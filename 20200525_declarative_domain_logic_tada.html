<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-05-25 Mon 14:04 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Declarative Domain Logic, Data-Driven Events, and the Tada library</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Joe" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Declarative Domain Logic, Data-Driven Events, and the Tada library</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org02883fa">1. The problem of <i>Fat Handlers</i></a></li>
<li><a href="#orgae68bb6">2. The Tada library</a></li>
<li><a href="#orga939313">3. Implications of a Data-Driven approach</a></li>
<li><a href="#orgb5749ca">4. Tada annotated Library</a>
<ul>
<li><a href="#orgced7285">4.1. Intro, deps and state</a></li>
<li><a href="#orgdaf9ebe">4.2. Terms</a></li>
<li><a href="#org0c8ccb5">4.3. Flow</a></li>
<li><a href="#orge377e8e">4.4. Specs</a>
<ul>
<li><a href="#org314715e">4.4.1. Condition Function</a></li>
<li><a href="#org95672f4">4.4.2. Event</a></li>
</ul>
</li>
<li><a href="#orgb6b4300">4.5. register</a></li>
<li><a href="#org7dbd317">4.6. do! helpers</a>
<ul>
<li><a href="#orge4dc91e">4.6.1. transformer - stripping extra stuff out of an event</a></li>
<li><a href="#orgad4aabf">4.6.2. sanitize-params - returns nil if spec not passed</a></li>
<li><a href="#org2135ffe">4.6.3. rule-errors - calls event conditions, returns true if passed</a></li>
<li><a href="#org4555231">4.6.4. explain-params-errors -</a></li>
</ul>
</li>
<li><a href="#orgb1105ce">4.7. do! - main dispatch function.</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<a href="https://www.youtube.com/watch?v=TFQlpBEpeks">https://www.youtube.com/watch?v=TFQlpBEpeks</a>
</p>

<div id="outline-container-org02883fa" class="outline-2">
<h2 id="org02883fa"><span class="section-number-2">1</span> The problem of <i>Fat Handlers</i></h2>
<div class="outline-text-2" id="text-1">
<p>
A WebApp is mostly front for a database (we care about managing data).
</p>

<p>
The design is some variation on this:
</p>

<p>
<code>client &lt;-&gt; app.handler &lt;-&gt; app.db &lt;-&gt; db</code>
</p>

<p>
Our handler supports routes, usually with a ~ 1:1 mapping with db operation
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span>PUT <span style="color: #b8bb26;">"/events/:event-if/book-ticket"</span>
     <span style="color: #b16286;">[</span>user-id event-id<span style="color: #b16286;">]</span>
     <span style="color: #7c6f64;">;; </span><span style="color: #7c6f64;">business logic here - check the stuff we're being sent, validate</span>
     <span style="color: #b16286;">(</span><span style="color: #d3869b;">db</span>/book-ticket! user-id event-id<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
</pre>
</div>

<p>
The 'business logic' in here gets big! Messy! Lots of branching! Very error prone and complected. It's entangled with HTTP. How do you test it? You have to mock HTTP calls (or stand up a web-server).
</p>

<p>
This is the <i>Fat Handler</i> pattern, and it's not great. we want separation of concerns.
</p>

<p>
We can use middleware/interceptors, which might be OK for generic things (e.g. type coercion). But we also need a lot a domain specific stuff.
</p>

<p>
We can put an <code>app.events</code> layer which separates the business logic from the handler implementation, which helps. But if we want a feature we now just have to create new 'thing' in every layer. And the events (as functions) are mostly doing the same stuff: checking input validity, state validity, and id everything is fine, processing an effect. It's still big, messy, complected. Mostly we're just moving the problem
</p>

<p>
The Clojure approach: make the event data.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">[</span><span style="color: #b16286;">{</span><span style="color: #d3869b;">:id</span> <span style="color: #d3869b;">:book-ticket!</span>

  <span style="color: #d3869b;">:params</span> <span style="color: #8ec07c;">{</span><span style="color: #d3869b;">:event-id</span> uuid?
           <span style="color: #d3869b;">:user-id</span>  uuid?<span style="color: #8ec07c;">}</span>

  <span style="color: #d3869b;">:conditions</span> <span style="color: #8ec07c;">(</span><span style="color: #fb4933;">fn</span> <span style="color: #d65d0e;">[</span><span style="color: #458588;">{</span><span style="color: #d3869b;">:keys</span> <span style="color: #b16286;">[</span>event-id user-id<span style="color: #b16286;">]</span><span style="color: #458588;">}</span><span style="color: #d65d0e;">]</span>
                <span style="color: #d65d0e;">(</span><span style="color: #fb4933;">let</span> <span style="color: #458588;">[</span>event <span style="color: #b16286;">(</span><span style="color: #d3869b;">db</span>/get-event event-id<span style="color: #b16286;">)</span><span style="color: #458588;">]</span>
                  <span style="color: #458588;">[</span><span style="color: #b16286;">[</span><span style="color: #8ec07c;">(</span><span style="color: #d3869b;">db</span>/user-exists? user-id<span style="color: #8ec07c;">)</span>
                    <span style="color: #d3869b;">:forbidden</span> <span style="color: #b8bb26;">"No user with that id"</span><span style="color: #b16286;">]</span>
                   <span style="color: #b16286;">[</span><span style="color: #8ec07c;">(</span><span style="color: #d3869b;">db</span>/event-exists? event-id<span style="color: #8ec07c;">)</span>
                    <span style="color: #d3869b;">:incorrect</span> <span style="color: #b8bb26;">"No event with that id"</span><span style="color: #b16286;">]</span>
                   <span style="color: #b16286;">[</span><span style="color: #8ec07c;">(</span>&lt;= <span style="color: #d65d0e;">(</span>event <span style="color: #d3869b;">:capacity</span><span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>event <span style="color: #d3869b;">:tickets-sold</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
                    <span style="color: #d3869b;">:unsupported</span> <span style="color: #b8bb26;">"Event at capacity"</span><span style="color: #b16286;">]</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>

  <span style="color: #d3869b;">:effect</span> <span style="color: #8ec07c;">(</span><span style="color: #fb4933;">fn</span> <span style="color: #d65d0e;">[</span><span style="color: #458588;">{</span><span style="color: #d3869b;">:keys</span> <span style="color: #b16286;">[</span>event-id user-id<span style="color: #b16286;">]</span><span style="color: #458588;">}</span><span style="color: #d65d0e;">]</span>
            <span style="color: #d65d0e;">(</span><span style="color: #fb4933;">-&gt;</span> <span style="color: #458588;">(</span><span style="color: #d3869b;">db</span>/book-ticket! user-id event-id<span style="color: #458588;">)</span>
                <span style="color: #d3869b;">email</span>/send-ticket-confirmation!<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">}</span><span style="color: #458588;">]</span>
</pre>
</div>

<p>
Then send it to a dispatch! function which checks the conditions and performs the side effect.
</p>

<p>
What do we get? Separation of concerns (conditions clearly separated from effect etc.)
</p>

<p>
All you can do with a function is call it - data is much more <i>transparent</i> and fungible.
</p>

<p>
With data, you can 'remix' the pieces, as you like - e.g. <i>make</i> a macro that creates a function from it (to get you back to where you were). Or generate Docs from it. Generate an rpc interface.
</p>

<p>
Did we just create objects? Yes, honestly. But we're only using them in a specific place, and they're not mutable state. And they're just data, there's no object baggage. So <i>good</i> objects :)
</p>
</div>
</div>

<div id="outline-container-orgae68bb6" class="outline-2">
<h2 id="orgae68bb6"><span class="section-number-2">2</span> The Tada library</h2>
<div class="outline-text-2" id="text-2">
<p>
Basically an implementation of the above.
</p>

<p>
You <code>register</code> events, then dispatch them with <code>do!</code> (kinda like react but on the backend)
</p>

<p>
More interesting things (not implemented as of 9/30/19): 
</p>
<ul class="org-ul">
<li>Derive Ring handler.</li>
<li>Deploy it to aws Lambda</li>
<li>Check 'hypothetical' event with <code>can?</code> - would you be allowed to do this if you wanted (i.e. conditions met)</li>
</ul>
</div>
</div>

<div id="outline-container-orga939313" class="outline-2">
<h2 id="orga939313"><span class="section-number-2">3</span> Implications of a Data-Driven approach</h2>
<div class="outline-text-2" id="text-3">
<p>
We tend to end up in a 'declarative' space for any problem after a while.
</p>

<p>
One potential direction is a web-app framework of declarative components (libraries) for solving particular problems, which ar configured with data.
</p>

<p>
An alternative: the data is the <i>domain model</i>, the business logic. Instead, we work out how to get domain model into the libraries. <code>Hodor</code> is a lib for describing entities (types). But entities/relationships (and events) are not the whole domain model. It's missing:
</p>
<ul class="org-ul">
<li>data-views (queries, subscriptions)</li>
<li>cross-cutting constraints</li>
<li>permissions (read and write)</li>
</ul>

<p>
We can get these from <i>different</i> libraries. But they are <i>connected</i> and often together.
</p>

<p>
This is the long term vision for <i>Tada</i>
</p>
</div>
</div>

<div id="outline-container-orgb5749ca" class="outline-2">
<h2 id="orgb5749ca"><span class="section-number-2">4</span> Tada annotated Library</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgced7285" class="outline-3">
<h3 id="orgced7285"><span class="section-number-3">4.1</span> Intro, deps and state</h3>
<div class="outline-text-3" id="text-4-1">
<p>
<a href="https://github.com/rafd/tada/blob/master/src/tada/events/core.cljc">https://github.com/rafd/tada/blob/master/src/tada/events/core.cljc</a>
</p>

<p>
This is a wonderfully small codebase of ~100 lines
</p>

<p>
You can see from the deps that spec (and spec tools) are used heavily.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span><span style="color: #fb4933;">ns</span> <span style="color: #d3869b;">tada.events.core</span>
  <span style="color: #b16286;">(</span><span style="color: #d3869b;">:require</span>
   <span style="color: #8ec07c;">[</span>clojure.spec.alpha <span style="color: #d3869b;">:as</span> s<span style="color: #8ec07c;">]</span>
   <span style="color: #8ec07c;">[</span>clojure.string <span style="color: #d3869b;">:as</span> string<span style="color: #8ec07c;">]</span>
   <span style="color: #8ec07c;">[</span>clojure.core.match <span style="color: #d3869b;">:as</span> match<span style="color: #8ec07c;">]</span>
   <span style="color: #8ec07c;">[</span>spec-tools.core <span style="color: #d3869b;">:as</span> st<span style="color: #8ec07c;">]</span>
   <span style="color: #8ec07c;">[</span>spec-tools.data-spec <span style="color: #d3869b;">:as</span> ds<span style="color: #8ec07c;">]</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
</pre>
</div>

<p>
The library follows a 'registry' model, where events are registered with the <code>register!</code> function. The implementation is a simple atom.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span><span style="color: #fb4933;">defonce</span> <span style="color: #83a598;">event-store</span> <span style="color: #b16286;">(</span>atom <span style="color: #8ec07c;">{}</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdaf9ebe" class="outline-3">
<h3 id="orgdaf9ebe"><span class="section-number-3">4.2</span> Terms</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li><b>event</b> - something that has happened. The event has a name (id), facts about it (params) which can be valid or invalid, an implementation (effect). Events are created and <b>registered</b>.</li>
<li><b>condition</b> - an invariant which must be checked before an event can be processed through its effect. For example before a 'ticket-booked' event can be processed, the 'has available capacity' condition must be met.</li>
<li><b>effect</b> - the implementation of an event, how it effects the world. A 'ticket-booked' event might send an email to the booker, and will record the event in a database.</li>
<li><b>anomaly</b></li>
<li><b>event-store</b> - where registered events are stored</li>
</ul>
</div>
</div>

<div id="outline-container-org0c8ccb5" class="outline-3">
<h3 id="org0c8ccb5"><span class="section-number-3">4.3</span> Flow</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>User creates <i>events</i>.</li>
<li>User <i>registers</i> the events.</li>
<li>User <i>dispatches</i> events (with passed args). The args are parsed and checked according to the event params and the conditions, and if everything looks good the 'effect' happens</li>
</ul>
</div>
</div>
<div id="outline-container-orge377e8e" class="outline-3">
<h3 id="orge377e8e"><span class="section-number-3">4.4</span> Specs</h3>
<div class="outline-text-3" id="text-4-4">
</div>
<div id="outline-container-org314715e" class="outline-4">
<h4 id="org314715e"><span class="section-number-4">4.4.1</span> Condition Function</h4>
<div class="outline-text-4" id="text-4-4-1">
<p>
The spec for <code>condition-fn</code> is not actually used, but included for illustrative purposes. So lets check it out
</p>

<p>
A <i>condition-function</i> (a function which is used in a condition?), it pretty simple: it takes a map, and returns a collections of maps which have <code>:status</code>, <code>:anomaly</code> and <code>:message</code> 
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span><span style="color: #d3869b;">s</span>/<span style="color: #fb4933;">def</span> <span style="color: #d3869b;">:</span><span style="color: #d3869b;">tada</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">condition-fn</span>
  <span style="color: #b16286;">(</span><span style="color: #d3869b;">ds</span>/spec
    <span style="color: #8ec07c;">{</span><span style="color: #d3869b;">:name</span> <span style="color: #d3869b;">:</span><span style="color: #d3869b;">tada</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">condition-fn</span>
     <span style="color: #d3869b;">:spec</span> <span style="color: #d65d0e;">(</span><span style="color: #d3869b;">s</span>/fspec
             <span style="color: #d3869b;">:args</span> <span style="color: #458588;">(</span><span style="color: #d3869b;">s</span>/cat <span style="color: #d3869b;">:arg</span> map?<span style="color: #458588;">)</span>
             <span style="color: #d3869b;">:ret</span> <span style="color: #458588;">(</span><span style="color: #d3869b;">s</span>/coll-of
                    <span style="color: #b16286;">(</span><span style="color: #d3869b;">s</span>/cat
                      <span style="color: #d3869b;">:status</span> boolean?
                      <span style="color: #d3869b;">:anomaly</span> keyword?
                      <span style="color: #d3869b;">:message</span> string?<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">}</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org95672f4" class="outline-4">
<h4 id="org95672f4"><span class="section-number-4">4.4.2</span> Event</h4>
<div class="outline-text-4" id="text-4-4-2">
<p>
An event is a map that has has <code>:params</code> and <code>:conditions</code> (condition functions), and optionally <code>:effect</code> and <code>:return</code>.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span><span style="color: #d3869b;">s</span>/<span style="color: #fb4933;">def</span> <span style="color: #d3869b;">:</span><span style="color: #d3869b;">tada</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">event</span>
  <span style="color: #b16286;">(</span><span style="color: #d3869b;">ds</span>/spec
    <span style="color: #8ec07c;">{</span><span style="color: #d3869b;">:name</span> <span style="color: #d3869b;">:</span><span style="color: #d3869b;">tada</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">event</span>
     <span style="color: #d3869b;">:spec</span> <span style="color: #d65d0e;">{</span><span style="color: #d3869b;">:params</span>          <span style="color: #458588;">{</span>keyword? <span style="color: #b16286;">(</span><span style="color: #d3869b;">ds</span>/or <span style="color: #8ec07c;">{</span><span style="color: #d3869b;">:keyword</span> keyword?
                                               <span style="color: #d3869b;">:fn</span>      fn?
                                               <span style="color: #d3869b;">:spec</span>    <span style="color: #d3869b;">s</span>/spec?<span style="color: #8ec07c;">}</span><span style="color: #b16286;">)</span><span style="color: #458588;">}</span>
            <span style="color: #d3869b;">:conditions</span>      fn? <span style="color: #7c6f64;">;; </span><span style="color: #7c6f64;">:tada/condition-fn</span>
            <span style="color: #458588;">(</span><span style="color: #d3869b;">ds</span>/opt <span style="color: #d3869b;">:effect</span><span style="color: #458588;">)</span> fn?
            <span style="color: #458588;">(</span><span style="color: #d3869b;">ds</span>/opt <span style="color: #d3869b;">:return</span><span style="color: #458588;">)</span> fn?<span style="color: #d65d0e;">}</span><span style="color: #8ec07c;">}</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #d3869b;">s</span>/<span style="color: #fb4933;">def</span> <span style="color: #d3869b;">:</span><span style="color: #d3869b;">tada</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">events</span>
  <span style="color: #b16286;">(</span><span style="color: #d3869b;">ds</span>/spec
    <span style="color: #8ec07c;">{</span><span style="color: #d3869b;">:name</span> <span style="color: #d3869b;">:</span><span style="color: #d3869b;">tada</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">events</span>
     <span style="color: #d3869b;">:spec</span> <span style="color: #d65d0e;">{</span>keyword? <span style="color: #d3869b;">:</span><span style="color: #d3869b;">tada</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">event</span><span style="color: #d65d0e;">}</span><span style="color: #8ec07c;">}</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #fb4933;">defn-</span> <span style="color: #fabd2f;">make-event-spec</span>
  <span style="color: #b16286;">[</span>event<span style="color: #b16286;">]</span>
  <span style="color: #b16286;">(</span><span style="color: #d3869b;">ds</span>/spec <span style="color: #8ec07c;">{</span><span style="color: #d3869b;">:name</span> <span style="color: #d65d0e;">(</span>keyword <span style="color: #b8bb26;">"ev-spec"</span> <span style="color: #458588;">(</span>name <span style="color: #b16286;">(</span>event <span style="color: #d3869b;">:id</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
            <span style="color: #d3869b;">:spec</span> <span style="color: #d65d0e;">(</span>event <span style="color: #d3869b;">:params</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">}</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb6b4300" class="outline-3">
<h3 id="orgb6b4300"><span class="section-number-3">4.5</span> register</h3>
<div class="outline-text-3" id="text-4-5">
<p>
Register is passed an event(s) (which is spec-checked), and if it's valid, registers it in the event-store.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span><span style="color: #fb4933;">defn</span> <span style="color: #fabd2f;">register!</span>
  <span style="color: #b16286;">[</span>events<span style="color: #b16286;">]</span>
  <span style="color: #b16286;">{</span><span style="color: #d3869b;">:pre</span>  <span style="color: #8ec07c;">[</span><span style="color: #d65d0e;">(</span>every? <span style="color: #458588;">(</span>partial <span style="color: #d3869b;">s</span>/valid? <span style="color: #d3869b;">:</span><span style="color: #d3869b;">tada</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">event</span><span style="color: #458588;">)</span> events<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">]</span>
   <span style="color: #d3869b;">:post</span> <span style="color: #8ec07c;">[</span><span style="color: #d65d0e;">(</span><span style="color: #d3869b;">s</span>/valid? <span style="color: #d3869b;">:</span><span style="color: #d3869b;">tada</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">events</span> @event-store<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">]</span><span style="color: #b16286;">}</span>
  <span style="color: #b16286;">(</span>swap! event-store merge
         <span style="color: #8ec07c;">(</span><span style="color: #fb4933;">-&gt;&gt;</span> events
              <span style="color: #d65d0e;">(</span>map <span style="color: #458588;">(</span><span style="color: #fb4933;">fn</span> <span style="color: #b16286;">[</span>event<span style="color: #b16286;">]</span>
                     <span style="color: #b16286;">[</span><span style="color: #8ec07c;">(</span>event <span style="color: #d3869b;">:id</span><span style="color: #8ec07c;">)</span>
                      <span style="color: #8ec07c;">(</span>assoc event <span style="color: #d3869b;">:params-spec</span>
                             <span style="color: #d65d0e;">(</span>make-event-spec event<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">]</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
              <span style="color: #d65d0e;">(</span>into <span style="color: #458588;">{}</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

</pre>
</div>

<p>
On the way in, it transforms each event into a kv pair of the event-id and the event, and also adds the spec of the event as a <code>:params-spec</code>.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #7c6f64;">;; </span><span style="color: #7c6f64;">in</span>
<span style="color: #458588;">[</span><span style="color: #b16286;">{</span><span style="color: #d3869b;">:id</span>         my-event
  <span style="color: #d3869b;">:params</span>     <span style="color: #8ec07c;">{</span><span style="color: #d3869b;">:some</span> <span style="color: #d3869b;">:map</span><span style="color: #8ec07c;">}</span>
  <span style="color: #d3869b;">:conditions</span> cond-fn
  <span style="color: #d3869b;">:effect</span>     fn1
  <span style="color: #d3869b;">:return</span>     fn2<span style="color: #b16286;">}</span><span style="color: #458588;">]</span>

<span style="color: #7c6f64;">;; </span><span style="color: #7c6f64;">out</span>
<span style="color: #458588;">{</span><span style="color: #d3869b;">:my-event</span> <span style="color: #b16286;">{</span><span style="color: #d3869b;">:id</span>          my-event
            <span style="color: #d3869b;">:params</span>      <span style="color: #8ec07c;">{</span><span style="color: #d3869b;">:some</span> <span style="color: #d3869b;">:map</span><span style="color: #8ec07c;">}</span>
            <span style="color: #d3869b;">:params-spec</span> ds-spec
            <span style="color: #d3869b;">:conditions</span>  cond-fn
            <span style="color: #d3869b;">:effect</span>      fn1
            <span style="color: #d3869b;">:return</span>      fn2<span style="color: #b16286;">}</span><span style="color: #458588;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7dbd317" class="outline-3">
<h3 id="org7dbd317"><span class="section-number-3">4.6</span> do! helpers</h3>
<div class="outline-text-3" id="text-4-6">
<p>
A few helpers for <code>do!</code>
</p>
</div>
<div id="outline-container-orge4dc91e" class="outline-4">
<h4 id="orge4dc91e"><span class="section-number-4">4.6.1</span> transformer - stripping extra stuff out of an event</h4>
<div class="outline-text-4" id="text-4-6-1">
<p>
Just a gloss on top of spec-tools transformer, stripping out extra stuff
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span><span style="color: #fb4933;">def</span> <span style="color: #83a598;">transformer</span>
  <span style="color: #b16286;">(</span><span style="color: #d3869b;">st</span>/type-transformer
    <span style="color: #d3869b;">st</span>/string-transformer
    <span style="color: #d3869b;">st</span>/strip-extra-keys-transformer
    <span style="color: #d3869b;">st</span>/strip-extra-values-transformer<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgad4aabf" class="outline-4">
<h4 id="orgad4aabf"><span class="section-number-4">4.6.2</span> sanitize-params - returns nil if spec not passed</h4>
<div class="outline-text-4" id="text-4-6-2">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span><span style="color: #fb4933;">defn-</span> <span style="color: #fabd2f;">sanitize-params</span>
  <span style="color: #b8bb26;">"Given a params-spec and params,</span>
<span style="color: #b8bb26;">   if the params pass the spec, returns the params</span>
<span style="color: #b8bb26;">     (eliding any extra keys and values)</span>
<span style="color: #b8bb26;">   if params do not pass spec, returns nil"</span>
  <span style="color: #b16286;">[</span>event params<span style="color: #b16286;">]</span>
  <span style="color: #b16286;">(</span><span style="color: #fb4933;">let</span> <span style="color: #8ec07c;">[</span>coerced-params <span style="color: #d65d0e;">(</span><span style="color: #d3869b;">st</span>/coerce <span style="color: #458588;">(</span>event <span style="color: #d3869b;">:params-spec</span><span style="color: #458588;">)</span> params transformer<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">]</span>
    <span style="color: #8ec07c;">(</span><span style="color: #fb4933;">when</span> <span style="color: #d65d0e;">(</span><span style="color: #d3869b;">s</span>/valid? <span style="color: #458588;">(</span>event <span style="color: #d3869b;">:params-spec</span><span style="color: #458588;">)</span> coerced-params<span style="color: #d65d0e;">)</span>
      coerced-params<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2135ffe" class="outline-4">
<h4 id="org2135ffe"><span class="section-number-4">4.6.3</span> rule-errors - calls event conditions, returns true if passed</h4>
<div class="outline-text-4" id="text-4-6-3">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span><span style="color: #fb4933;">defn-</span> <span style="color: #fabd2f;">rule-errors</span>
  <span style="color: #b8bb26;">"Returns boolean of whether the the conditions for an event are satisfied.</span>
<span style="color: #b8bb26;">   Should be called with sanitized-params."</span>
  <span style="color: #b16286;">[</span>event sanitized-params<span style="color: #b16286;">]</span>
  <span style="color: #b16286;">(</span><span style="color: #fb4933;">-&gt;&gt;</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>event <span style="color: #d3869b;">:conditions</span><span style="color: #d65d0e;">)</span> sanitized-params<span style="color: #8ec07c;">)</span>
       <span style="color: #8ec07c;">(</span>remove <span style="color: #d65d0e;">(</span><span style="color: #fb4933;">fn</span> <span style="color: #458588;">[</span><span style="color: #b16286;">[</span>pass? _ _<span style="color: #b16286;">]</span><span style="color: #458588;">]</span> pass?<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
       <span style="color: #8ec07c;">(</span>map <span style="color: #d65d0e;">(</span><span style="color: #fb4933;">fn</span> <span style="color: #458588;">[</span><span style="color: #b16286;">[</span>pass? anomaly message<span style="color: #b16286;">]</span><span style="color: #458588;">]</span>
              <span style="color: #458588;">{</span><span style="color: #d3869b;">:anomaly</span> anomaly
               <span style="color: #d3869b;">:message</span> message<span style="color: #458588;">}</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4555231" class="outline-4">
<h4 id="org4555231"><span class="section-number-4">4.6.4</span> explain-params-errors -</h4>
<div class="outline-text-4" id="text-4-6-4">
<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span><span style="color: #fb4933;">defn</span> <span style="color: #fabd2f;">explain-params-errors</span> <span style="color: #b16286;">[</span>spec value<span style="color: #b16286;">]</span>
  <span style="color: #b16286;">(</span><span style="color: #fb4933;">-&gt;&gt;</span> <span style="color: #8ec07c;">(</span><span style="color: #d3869b;">s</span>/explain-data spec value<span style="color: #8ec07c;">)</span>
       <span style="color: #d3869b;">::</span><span style="color: #d3869b;">s</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">problems</span>
       <span style="color: #8ec07c;">(</span>map <span style="color: #d65d0e;">(</span><span style="color: #fb4933;">fn</span> <span style="color: #458588;">[</span><span style="color: #b16286;">{</span><span style="color: #d3869b;">:keys</span> <span style="color: #8ec07c;">[</span>path pred val via in<span style="color: #8ec07c;">]</span><span style="color: #b16286;">}</span><span style="color: #458588;">]</span>
              <span style="color: #458588;">(</span><span style="color: #d3869b;">match</span>/match <span style="color: #b16286;">[</span>pred<span style="color: #b16286;">]</span>
                           <span style="color: #b16286;">[</span><span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">[</span>fn <span style="color: #458588;">[</span>_<span style="color: #458588;">]</span> <span style="color: #458588;">(</span><span style="color: #458588;">[</span>contains? _ missing-key<span style="color: #458588;">]</span> <span style="color: #d3869b;">:seq</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">]</span> <span style="color: #d3869b;">:seq</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">]</span> <span style="color: #b16286;">{</span><span style="color: #d3869b;">:issue</span>    <span style="color: #d3869b;">:missing-key</span>
                                                                               <span style="color: #d3869b;">:key-path</span> <span style="color: #8ec07c;">(</span>conj path missing-key<span style="color: #8ec07c;">)</span><span style="color: #b16286;">}</span>
                           <span style="color: #b16286;">[</span>_<span style="color: #b16286;">]</span> <span style="color: #b16286;">{</span><span style="color: #d3869b;">:issue</span>    <span style="color: #d3869b;">:incorrect-value</span>
                                <span style="color: #d3869b;">:key-path</span> path<span style="color: #b16286;">}</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
       <span style="color: #8ec07c;">(</span>map <span style="color: #d65d0e;">(</span><span style="color: #fb4933;">fn</span> <span style="color: #458588;">[</span><span style="color: #b16286;">{</span><span style="color: #d3869b;">:keys</span> <span style="color: #8ec07c;">[</span>issue key-path<span style="color: #8ec07c;">]</span><span style="color: #b16286;">}</span><span style="color: #458588;">]</span>
              <span style="color: #458588;">(</span>str key-path <span style="color: #b8bb26;">" "</span> issue<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
       <span style="color: #8ec07c;">(</span><span style="color: #d3869b;">string</span>/join <span style="color: #b8bb26;">"</span><span style="color: #b8bb26; font-weight: bold;">\n</span><span style="color: #b8bb26;">"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb1105ce" class="outline-3">
<h3 id="orgb1105ce"><span class="section-number-3">4.7</span> do! - main dispatch function.</h3>
<div class="outline-text-3" id="text-4-7">
<ul class="org-ul">
<li>checks params are OK (if they're not, it throws)</li>
<li>checks conditions (if not, throws)</li>
<li>runs the 'effect' of an event</li>
<li>reuns the 'return' function on a map of the params (with the return from the effect added into it)</li>
</ul>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #458588;">(</span><span style="color: #fb4933;">defn</span> <span style="color: #fabd2f;">do!</span> <span style="color: #b16286;">[</span>event-id params<span style="color: #b16286;">]</span>
  <span style="color: #b16286;">(</span><span style="color: #fb4933;">if-let</span> <span style="color: #8ec07c;">[</span>event <span style="color: #d65d0e;">(</span>@event-store event-id<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">]</span>
    <span style="color: #8ec07c;">(</span><span style="color: #fb4933;">if-let</span> <span style="color: #d65d0e;">[</span>sanitized-params <span style="color: #458588;">(</span>sanitize-params event params<span style="color: #458588;">)</span><span style="color: #d65d0e;">]</span>
      <span style="color: #d65d0e;">(</span><span style="color: #fb4933;">let</span> <span style="color: #458588;">[</span>errors <span style="color: #b16286;">(</span>rule-errors event sanitized-params<span style="color: #b16286;">)</span><span style="color: #458588;">]</span>
        <span style="color: #458588;">(</span><span style="color: #fb4933;">if</span> <span style="color: #b16286;">(</span>empty? errors<span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span><span style="color: #fb4933;">let</span> <span style="color: #8ec07c;">[</span>effect-return <span style="color: #d65d0e;">(</span><span style="color: #fb4933;">when</span> <span style="color: #458588;">(</span>event <span style="color: #d3869b;">:effect</span><span style="color: #458588;">)</span>
                                <span style="color: #458588;">(</span><span style="color: #458588;">(</span>event <span style="color: #d3869b;">:effect</span><span style="color: #458588;">)</span> sanitized-params<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">]</span>
            <span style="color: #8ec07c;">(</span><span style="color: #fb4933;">if</span> <span style="color: #d65d0e;">(</span>event <span style="color: #d3869b;">:return</span><span style="color: #d65d0e;">)</span>
              <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>event <span style="color: #d3869b;">:return</span><span style="color: #458588;">)</span> <span style="color: #458588;">(</span>assoc sanitized-params
                                      <span style="color: #d3869b;">:</span><span style="color: #d3869b;">tada</span><span style="color: #fdf4c1; background-color: #282828;">/</span><span style="color: #d3869b;">effect-return</span> effect-return<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
              <span style="color: #d3869b;">nil</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span><span style="color: #fb4933;">throw</span> <span style="color: #8ec07c;">(</span>ex-info <span style="color: #d65d0e;">(</span>str <span style="color: #b8bb26;">"Conditions for event "</span> event-id <span style="color: #b8bb26;">" are not met:</span><span style="color: #b8bb26; font-weight: bold;">\n</span><span style="color: #b8bb26;">"</span>
                               <span style="color: #458588;">(</span><span style="color: #d3869b;">string</span>/join <span style="color: #b8bb26;">"</span><span style="color: #b8bb26; font-weight: bold;">\n</span><span style="color: #b8bb26;">"</span> <span style="color: #458588;">(</span>map <span style="color: #d3869b;">:message</span> errors<span style="color: #458588;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
                          <span style="color: #d65d0e;">{</span><span style="color: #d3869b;">:anomaly</span> <span style="color: #d3869b;">:incorrect</span><span style="color: #d65d0e;">}</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #fb4933;">throw</span> <span style="color: #458588;">(</span>ex-info <span style="color: #b16286;">(</span>str <span style="color: #b8bb26;">"Params for event "</span> event-id <span style="color: #b8bb26;">" do not meet spec:</span><span style="color: #b8bb26; font-weight: bold;">\n</span><span style="color: #b8bb26;">"</span>
                           <span style="color: #8ec07c;">(</span>explain-params-errors <span style="color: #d65d0e;">(</span>event <span style="color: #d3869b;">:params-spec</span><span style="color: #d65d0e;">)</span> params<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
                      <span style="color: #b16286;">{</span><span style="color: #d3869b;">:anomaly</span> <span style="color: #d3869b;">:incorrect</span><span style="color: #b16286;">}</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #fb4933;">throw</span> <span style="color: #d65d0e;">(</span>ex-info <span style="color: #458588;">(</span>str <span style="color: #b8bb26;">"No event with id "</span> event-id<span style="color: #458588;">)</span>
                    <span style="color: #458588;">{</span><span style="color: #d3869b;">:event-id</span> event-id
                     <span style="color: #d3869b;">:anomaly</span>  <span style="color: #d3869b;">:unsupported</span><span style="color: #458588;">}</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Joe</p>
<p class="date">Created: 2020-05-25 Mon 14:04</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
