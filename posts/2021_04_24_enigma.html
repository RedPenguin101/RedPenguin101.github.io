<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Let&#8217;s make an Enigma machine</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>Let&#8217;s make an Enigma machine</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The story of the enigma machine is famous for it&#8217;s association with the work of Bletchley Park and Alan Turing in <em>breaking</em> the enigma. Genius mathematicians with the aid of groundbreaking computers achieved the seemingly impossible, enabling the Allies to read the German codes and aiding in the winning of the war.</p>
</div>
<div class="paragraph">
<p>I want to understand how the Enigma machines actually worked, by building a model of the machine in code.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
I can&#8217;t get my enigma to replicate the results of the one <a href="https://cryptii.com/pipes/enigma-machine">here</a>. I assume there&#8217;s something subtly wrong with my implementation, but I think the overall pieces are correct.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operation_of_the_enigma_machine">Operation of the Enigma machine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The enigma machine allows you to encode a message (called <strong>plaintext</strong>) so that no-one can read it except a person who also has an enigma machine and knows what settings you used to encode it. Or unless you can crack the code.</p>
</div>
<div class="paragraph">
<p>The actual enigma machine looked like a big typewriter, with a keyboard at the front, and, just above that, a set of lights that mirror the keyboard layout, called the <strong>lamp board</strong>. When someone types a letter on the keyboard, a light on the lamp board illuminates, and that tells you what the encoded letter is.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/enigma/1_1_enigma.jpg" alt="1 1 enigma">
</div>
</div>
<div class="paragraph">
<p>The writer sets up the enigma machine in a particular way, types in the plaintext, and writes down letter-by-letter the encoded message. They then transmit that encoded message to the reader. The reader, using <em>their</em> enigma machine, types in the encoded message, and provided they set up the machine in <em>exactly the same way as the writer</em>, they will get back the original plaintext message.</p>
</div>
<div class="paragraph">
<p>How did the writer and reader know which settings to use? The most common way of doing this was the code book. Sent out monthly, it contained for each day in that month the settings to be used.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/enigma/enigma-code-book.png" alt="enigma code book">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_components_of_the_machine">Components of the machine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The machine works by scrambling letters using ever more elaborate mechanisms. We&#8217;re going to build up our model piece by piece in the following steps, explaining each as we go:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The reflector</p>
</li>
<li>
<p>The rotors</p>
</li>
<li>
<p>The window setting of the rotors</p>
</li>
<li>
<p>The Notch positions</p>
</li>
<li>
<p>Ring settings</p>
</li>
<li>
<p>The Plugboard</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We are also going to work with a very truncated alphabet of A through D (4 letters), to make the mechanics more comprehensible: a minigma, if you like.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_our_minigma_model">Setting up our minigma model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clearly, we want a nice simple top-level function for encoding or decoding our message. Something like <code>encode : plaintext, machine-settings &#8594; encoded-message</code>.</p>
</div>
<div class="paragraph">
<p>What are the machine settings that are necessary here? The settings sheet above suggests we need the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The rotors to be used</p>
</li>
<li>
<p>The ring settings of those rotors</p>
</li>
<li>
<p>The initial rotor positions (or window values)</p>
</li>
<li>
<p>The plugboard settings</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>However, since we don&#8217;t really know what any of that means yet, we don&#8217;t need to decide on how we want to represent them. In fact we&#8217;re going to ignore the machine settings altogether for now.</p>
</div>
<div class="paragraph">
<p>Letters are encoded one-by-one as the writer types, and you stop when you have no more letters to encode. So our top level function will reflect this by calling <code>encode-letter</code> on the first letter of the plaintext until there is nothing left to encode.</p>
</div>
<div class="paragraph">
<p>Stubbing out an <code>encode-letter</code> function we get something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(def encode-letter identity)

(defn encode [encoded plaintext]
  (if (empty? plaintext) encoded
      (recur (conj encoded (encode-letter (first plaintext)))
             (rest plaintext))))

(apply str (encode [] "HELLOWORLD"))
;; =&gt; "HELLOWORLD"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we start we should think about representation a bit. Letters are awkward to deal with, so we&#8217;ll use numbers 0-25 in the actual encode function, and provide a couple of functions to get from and to the letter notation at the start and end of each encoding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(def alpha (zipmap "ABCDEFGHIJKLMNOPQRSTUVWXYZ" (range)))
(defn str-&gt;num [string] (mapv alpha string))
(defn num-&gt;str [nums] (apply str (map (map-invert alpha) nums)))

(str-&gt;num "HELLOWORLD")
;; =&gt; [7 4 11 11 14 22 14 17 11 3]
(num-&gt;str [7 4 11 11 14 22 14 17 11 3])
;; =&gt; "HELLOWORLD"

(-&gt;&gt; "HELLOWORLD"
     str-&gt;num
     (encode [])
     num-&gt;str)
;; =&gt; "HELLOWORLD"</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s as much setup as we need, let&#8217;s get on to actually modelling the machine</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_reflector">The Reflector</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first piece of puzzle is the reflector. This takes the letter signal from the keyboard, and wires it up to another letter. For our simple reflector, we&#8217;re going to say A is wired to C, and B is wired to D,</p>
</div>
<div class="paragraph">
<p>Drawing this up, you can trace the path of each input letter, through the reflector to the output. If you type A on the keyboard, the C on the lamp board will light up. And if you type C, A will light up.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/enigma/enigma.jpg" alt="enigma">
</div>
</div>
<div class="paragraph">
<p>The first property to notice that this is <em>reciprocal</em> (A&#8594;C and C&#8594;A). This is a critical property because it&#8217;s what allows the decoding. Putting the encoded message back into the machine will give you back the plaintext.</p>
</div>
<div class="paragraph">
<p>The second property to notice is that you <em>can never have a letter that comes back as itself</em>. You will never have a letter that goes in as an A and comes back as an A. This was a weakness of the machine that was exploited at Bletchley Park.</p>
</div>
<div class="paragraph">
<p>Since this is a simple mapping, we can represent it as a simple map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(def simple-reflector
  (zipmap (str-&gt;num "ABCD")
          (str-&gt;num "CDAB")))

simple-reflector
;; =&gt; {0 2, 1 3, 2 0, 3 1}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now for each letter that gets passed into <code>encode-letter</code>, we need to move it through the reflector. In this case <code>encode-letter</code> <em>is</em> the map.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(def encode-letter simple-reflector)

(-&gt;&gt; "ABCD"
     str-&gt;num
     (map encode-letter)
     num-&gt;str)
;; =&gt; "CDAB"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s also change our <code>encode</code> fn to make it a bit less fussy, and take and return a string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn encode
  ([plaintext] (encode [] (str-&gt;num plaintext)))
  ([encoded plaintext]
   (if (empty? plaintext) (num-&gt;str encoded)
       (recur (conj encoded (encode-letter (first plaintext)))
              (rest plaintext)))))

(encode "ABCDBBB")
;; =&gt; "CDABDDD"
(encode "CDABDDD")
;; =&gt; "ABCDBBB"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the reciprocal property: Running the encoded message back through the machine gives the plaintext.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_rotors">The Rotors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The enigma machine had a slot for three rotors. A rotor takes a signal in (a letter or 0-26 number), and through fixed wiring, outputs it as a different number.</p>
</div>
<div class="paragraph">
<p>So this adds three additional layers of scrambling. Initially there were three rotors for the three slots, though they could be put in in any order. New rotors were added over time, until eventually the Navy used eight, denoted in roman numerals I-VIII, from which any three could be used in the machine in any order.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll start off super simple, with a single rotor, which has 4 inputs and outputs, one for each of ABCD. Let&#8217;s say this rotor maps A to B, B to D, C to A, and D to C. This sounds pretty much like the reflector, so we could represent it the same way, as a map.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(def simple-rotor1
  (zipmap (str-&gt;num "ABCD")
          (str-&gt;num "BDAC")))</code></pre>
</div>
</div>
<div class="paragraph">
<p>We do have to be a bit careful here in using a map, because this is not a <em>complete</em> description of a rotor. We know from the settings and a description of the components that a rotor also has a notch, a ring <em>setting</em>, and an initial position. It&#8217;s likely we will need a richer data structure to represent a rotor, so lets make a simple initial abstraction on top of that.</p>
</div>
<div class="paragraph">
<p>First, we&#8217;ve written <code>(zipmap (str&#8594;num "ABCD") (str&#8594;num y))</code> to get from ABCD to a permutation of ABCD, a couple of times already, and we&#8217;ll certainly need it again, so lets make a function for that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn alpha-mapping [string]
  (zipmap (str-&gt;num "ABCDEFGHIJKLMNOPQRSTUVWXYZ")
          (str-&gt;num string)))

(def simple-reflector (alpha-mapping "CDAB"))
(def simple-rotor1 (alpha-mapping "BDAC"))

simple-reflector
;; =&gt; {0 2, 1 3, 2 0, 3 1}
simple-rotor1
;; =&gt; {0 1, 1 3, 2 0, 3 2}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we&#8217;ll make a constructor for a rotor</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn rotor [string] {:mapping (alpha-mapping string)})

(rotor "BDAC")
;; =&gt; {:mapping {0 1, 1 3, 2 0, 3 2}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This isn&#8217;t very good and will almost certainly need to change as we write the code, but it&#8217;s probably good enough for now, and will require less change than just representing a rotor as a straight map.</p>
</div>
<div class="paragraph">
<p>It also allows us a neat unique notation for a rotor. If we want a rotor that maps ABCD BDAC, that&#8217;s just denoted as <code>(rotor "BDAC")</code>. Nice and clean.</p>
</div>
<div class="paragraph">
<p>Now lets look at how the rotor works. Plugging the rotor into our machine, we can now trace a path for each letter through the rotor, through the reflector, and back through the rotor, and we end up with a different letter.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/enigma/enigma(1).jpg" alt="enigma(1)">
</div>
</div>
<div class="paragraph">
<p>We expect to get back:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A &#8594; B</p>
</li>
<li>
<p>B &#8594; A</p>
</li>
<li>
<p>C &#8594; D</p>
</li>
<li>
<p>D &#8594; C</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is going to complicate our <code>encode-letter</code> a bit. First, the rotors are not fixed, so they need to be passed into the function as an argument. (the reflector, in this model of enigma at least, is fixed).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn encode-letter [letter rotors]
  (simple-reflector letter))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we need to make a design decision. We know that in the <em>actual</em> enigma machine, there are always exactly 3 rotors. So we could have a signature like <code>encode-letter : letter r1 r2 r3 &#8594; letter</code>. But if we do this it could get quite hard to change. And it might be nice to be able to have a number of rotors other than 3.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, right now we only have one rotor, so tying ourselves to 3 means we&#8217;ll have to create more, or reuse the existing one.</p>
</li>
<li>
<p>Second, for testing and generally for comprehensibility, it might be nicer to use less than three. It&#8217;s just easier for us to see what&#8217;s going on.</p>
</li>
<li>
<p>And third, if we want to make a machine that has <em>more</em> than 3 rotors in the future, this would make it harder.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There&#8217;s no right answer here, but I&#8217;m going to code it in a way that allows variable numbers of rotors, since I don&#8217;t think it will increase complexity much.</p>
</div>
<div class="paragraph">
<p>To encode the letter we want our procedure to be something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>letter
|&gt; run through rotors
|&gt; run through reflector
|&gt; run though rotors again, but in reverse*</pre>
</div>
</div>
<div class="paragraph">
<p>(* reversed both the order of the rotors, and the rotors themselves)</p>
</div>
<div class="paragraph">
<p>So let&#8217;s just do that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn run-through-rotors [letter rotor-mappings]
  (if (empty? rotor-mappings)
    letter
    (recur ((first rotor-mappings) letter)
           (rest rotor-mappings))))

(defn encode-letter [letter rotor-mappings]
  (-&gt; letter
      (run-through-rotors rotor-mappings)
      simple-reflector
      (run-through-rotors (reverse (map map-invert rotor-mappings)))))


(num-&gt;str (map #(run-through-rotors % [(:mapping (rotor "BDAC"))]) (str-&gt;num "ABCD")))
;; =&gt; "BDAC", i.e. how we specified the rotor

(num-&gt;str (map #(encode-letter % [(:mapping (rotor "BDAC"))]) (str-&gt;num "ABCD")))
;; =&gt; "BADC"
;; matching the diagram of the rotor + reflector</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that I&#8217;ve passed in the <em>rotor-mappings</em> here, rather than the rotors themselves. This might not be a good idea. But we&#8217;ll see.</p>
</div>
<div class="paragraph">
<p>Finally, update the encode, passing in the rotors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn encode
  ([plaintext rotors] (encode [] (str-&gt;num plaintext) rotors))
  ([encoded plaintext rotors]
   (if (empty? plaintext) (num-&gt;str encoded)
       (recur (conj encoded (encode-letter (first plaintext) (map :mapping rotors)))
              (rest plaintext)
              rotors))))

(encode "ABCDBBB" [(rotor "BDAC")])
;; =&gt; "BADCAAA"
(encode "BADCAAA" [(rotor "BDAC")])
;; =&gt; "ABCDBBB"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add another simple rotor and make sure our answers still make sense. We&#8217;ll add a rotor with mapping "BADC". If we diagram this out, if that&#8217;s the only rotor, we would expect this to to encode ABCD as CDAB.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/enigma/enigma(2).jpg" alt="enigma(2)">
</div>
</div>
<div class="paragraph">
<p>If used in combination with our other rotor (BDAC), we expect to encode ABCD as BADC.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/enigma/enigma(3).jpg" alt="enigma(3)">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s check if it works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(encode "ABCD" [(rotor "BADC")])
;; =&gt; "CDAB"
(encode "CDAB" [(rotor "BADC")])
;; =&gt; "ABCD"

(encode "ABCD" [(rotor "BADC") (rotor "BDAC")])
;; =&gt; "BADC"
(encode "BADC" [(rotor "BADC") (rotor "BDAC")])
;; =&gt; "ABCD"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Success!</p>
</div>
<div class="paragraph">
<p>Before moving on, let&#8217;s check that we can handle the full alphabet. From this <a href="https://en.wikipedia.org/wiki/Enigma_rotor_details#Rotor_wiring_tables">wiki page</a>, we can see that first 3 rotors on the actual enigma1 were:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>I:   EKMFLGDQVZNTOWYHXUSPAIBRCJ</p>
</li>
<li>
<p>II:  AJDKSIRUXBLHWTMCQGZNPYFVOE</p>
</li>
<li>
<p>III: BDFHJLCPRTXVZNYEIWGAKMUSQO</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So we should be able to just plug these in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(encode "HELLOWORLD" [(rotor "EKMFLGDQVZNTOWYHXUSPAIBRCJ")
                      (rotor "AJDKSIRUXBLHWTMCQGZNPYFVOE")
                      (rotor "BDFHJLCPRTXVZNYEIWGAKMUSQO")])
;; =&gt; ""</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ah, no good. Thinking about it, we still have our <em>simple-reflector</em> plugged in, which only deals with ABCD. We need to replace it with a proper reflector. I actually had a bit of trouble tracking down the actual reflector wiring on the enigma I. I found <em>a</em> reflector setting from the 'Swiss-K' model, so I&#8217;m just going to use that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(def reflector (alpha-mapping "IMETCGFRAYSQBZXWLHKDVUPOJN"))
;; also changed encode-letter to use the full reflector

(encode "HELLOWORLD" [(rotor "EKMFLGDQVZNTOWYHXUSPAIBRCJ")
                      (rotor "AJDKSIRUXBLHWTMCQGZNPYFVOE")
                      (rotor "BDFHJLCPRTXVZNYEIWGAKMUSQO")])
;; =&gt; "KFMMJZJXMY"
(encode "KFMMJZJXMY" [(rotor "EKMFLGDQVZNTOWYHXUSPAIBRCJ")
                      (rotor "AJDKSIRUXBLHWTMCQGZNPYFVOE")
                      (rotor "BDFHJLCPRTXVZNYEIWGAKMUSQO")])
;; =&gt; "HELLOWORLD"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nice! I&#8217;m going to switch the machine back to the simple reflector for now. You could argue that it should be being passed in as a parameter, but I don&#8217;t think it&#8217;s necessary.</p>
</div>
<div class="paragraph">
<p>Now we&#8217;re at a bit under 30 lines of code, and have a few examples, it&#8217;s probably best to write some tests. Not <em>too</em> many, because we haven&#8217;t fully modelled our rotors, so "HELLOWORLD" isn&#8217;t going to encode to "KFMMJZJXMY" when we implement that behaviour. But we can do a few things.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(deftest degen-identity
  (is (= "" (encode "" [])))
  (is (= "" (encode "" [(rotor "DABC") (rotor "ABDC")])))
  ;; If rotors are 'identity' rotors, i.e. everything maps to itself,
  ;; then it should be the same as running through with no rotors at all
  (is (= (encode "ABCD" [])
         (encode "ABCD" [(rotor "ABCD")])
         (encode "ABCD" [(rotor "ABCD") (rotor "ABCD")])
         (encode "ABCD" [(rotor "ABCD") (rotor "ABCD") (rotor "ABCD")]))))

(deftest these-will-break
  (is (= "CDAB" (encode "ABCD" [(rotor "BADC")])))
  (is (= "ABCD" (encode "CDAB" [(rotor "BADC")])))
  (is (= "BADC" (encode "ABCD" [(rotor "BADC") (rotor "BDAC")])))
  (is (= "ABCD" (encode "BADC" [(rotor "BADC") (rotor "BDAC")])))
  (is (= "CDAB" (encode "ABCD" [(rotor "ABCD") (rotor "ABCD")]))))

(deftest reflection
  (let [rotors [(rotor "BADC") (rotor "ACDB") (rotor "BDAC")]]
    (are [input] (= input (-&gt; input (encode rotors) (encode rotors)))
      "ABCD"
      "BCAD"
      "CADB")))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would be a great use case for property based testing, but it&#8217;s quite a heavy lift for this small thing.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_window_numbers_and_initial_rotor_positions">Window numbers and initial rotor positions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far our cipher is pretty primitive. The rotors are fixed, though you can use them in any order. So with 3 rotors available, you have 3!, or 6 possible combinations. With 8 rotors available you have 8p3 = 336 possibilities. If an attacker had a machine, they would have to try at most 336 possibilities to crack the code. Not great.</p>
</div>
<div class="paragraph">
<p>One way to introduce more complexity is allow the users to 'rotate' the rotors (as the name suggests!). For each rotor, then, you&#8217;ll be able to set it in any one of <em>n</em> positions, where <em>n</em> is the number of letters. So 26 for a full one, and 4 for our minigma. If we have chosen three rotors, we can set each in 26^3 ways. So an 8 rotor enigma will have 336*26^3, about 6m, possible settings. Which is much better!</p>
</div>
<div class="paragraph">
<p>The way the enigma is built, the rotors have a ring of letters, or numbers, round the edge, and when they are slotted into the machine, there is a window which shows one value. This 'window value' is how you set the rotation, or <strong>initial rotor position</strong>.</p>
</div>
<div class="paragraph">
<p>So, how do we model this. In particular, is the window value a property of the rotor itself, or of the machine? I&#8217;m a bit torn on this.</p>
</div>
<div class="paragraph">
<p>The properties of the rotor are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the mapping of the rotors themselves, e.g. A maps to B etc.</p>
</li>
<li>
<p>The window setting of the rotors</p>
</li>
<li>
<p>The Notch positions</p>
</li>
<li>
<p>Ring settings</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first one we&#8217;ve covered.</p>
</div>
<div class="paragraph">
<p>The second we&#8217;ve touched on, but a complication is that the rotors themselves are not fixed, ultimately they are going to rotate as you write. i.e. the window value is going to increase as you write. The right most rotor is going rotate by one each time you hit a letter. The middle is going to rotate once every 26 letters. The leftmost is going to rotate every (26*26) 676 times. This is achieved by the rotors <em>notch positions</em>. If you have a rightmost rotor where the notch position is R, then every time the rotor moves from Q to R, the middle rotor will rotate one notch.</p>
</div>
<div class="paragraph">
<p>One added complication is that some rotors can have multiple notches.</p>
</div>
<div class="paragraph">
<p>Finally, the mapping itself is not fixed. You can take a rotor and shift the internal wiring. So if A mapped to G, and B maps to R you can shift the internal wiring by one notch, so <em>B</em> maps to G, and <em>C</em> maps to R. We&#8217;re not going to model this explicitly yet, but we should try to factor it into our modelling decision.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at our options and try to decide</p>
</div>
<div class="sect2">
<h3 id="_modelling_the_window_value_as_a_property_of_the_rotor">Modelling the window value as a property of the rotor</h3>
<div class="paragraph">
<p>In this case, all of the initial rotor settings would be passed into the constructor, something like <code>(rotor mapping notch ring-setting init-pos)</code>, or <code>(rotor "BDAC" "B" "D" "A")</code></p>
</div>
<div class="paragraph">
<p>The notch and ring setting are fixed for a given encoding, so don&#8217;t need to be changed. The ring setting will change the initial mapping. The notch will remain unchanged for the construction.</p>
</div>
<div class="paragraph">
<p>The position will potentially change every time you hit a letter, so we&#8217;ll need a function like <code>(rotate rotor)</code> which will in effect shift the mapping and the notch by 1 position, as both rotate.</p>
</div>
<div class="paragraph">
<p>And we&#8217;ll need a function <code>(step rotors)</code> which, for every button press, will rotate the rightmost rotor, rotate the middle one if the left rotor notch positions are passed, and rotate the leftmost rotor if the <em>middle</em> rotor passes one of it&#8217;s notch positions.</p>
</div>
<div class="paragraph">
<p>The main benefit here is that everything is nicely self-contained.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(recur (encode-letter (first plaintext) rotors)
       (rest plaintext)
       (progress rotors)))</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modelling_the_window_value_as_a_property_of_the_machine">Modelling the window value as a property of the machine</h3>
<div class="paragraph">
<p>This would imply an <code>encode</code> signature of something like <code>(encode plaintext window-values rotors)</code>. Our recursion in the encode function would be something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(recur (encode-letter (first plaintext) window-values rotors)
       (rest plaintext)
       (increment window-values rotors)
       rotors))</pre>
</div>
</div>
<div class="paragraph">
<p>This is a little messier perhaps, but I am probably not thinking through all the implications here.</p>
</div>
<div class="paragraph">
<p>The main benefit is that it separates what is fixed from what changes over the course of an encoding. Once you&#8217;ve set the notch and ring settings at the start of the encoding, they don&#8217;t change over the course of the encoding, whereas the window value does.</p>
</div>
<div class="paragraph">
<p>It also fits nicely with the physical process that is being modelled. You close up the rotors, and then the rotor part of the problem is done. It&#8217;s only when you insert them into the machine that the window position starts to come into play.</p>
</div>
<div class="paragraph">
<p>Ultimately the best way to figure out what the best way is is to write the code. I am going to go with the self contained method and make everything part of the rotors, since my gut tells me that will be better. But who knows.</p>
</div>
</div>
<div class="sect2">
<h3 id="_modelling">Modelling</h3>
<div class="paragraph">
<p>All that being said, we&#8217;re going to ignore the notch and ring setting for now, and focus on the window. One way to do this is to maintain the window as a value in the rotor object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn rotor [mapping init-pos]
  {:mapping (alpha-mapping mapping)
   :window (alpha (first init-pos))})</code></pre>
</div>
</div>
<div class="paragraph">
<p>But I think there&#8217;s a potentially better way. To see, let&#8217;s dig into what&#8217;s happening when we shift the window:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/enigma/enigma(4).jpg" alt="enigma(4)">
</div>
</div>
<div class="paragraph">
<p>However, this is completely equivalent to writing the end result of the transformation as an effectively new mapping that can be expressed using modulo arithmetic:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/enigma/enigma(5).jpg" alt="enigma(5)">
</div>
</div>
<div class="paragraph">
<p>In general, rotating the rotor i times is equivalent to a new mapping, where over every value of the map, you apply the transformation <code>(x-i mod n)</code> (where n is the number of letters in the rotor.)</p>
</div>
<div class="paragraph">
<p>This suggests you don&#8217;t need to store the window at all, only the result of the transformation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn rotate [rotor steps]
  (letfn [(f [v] (mod (- v steps) (count (:mapping rotor))))]
    (-&gt; rotor
        (assoc :mapping (into {} (map (fn [[k v]] [(f k) (f v)]) (:mapping rotor)))))))

(defn rotor [mapping init-pos]
  (-&gt; {:mapping (alpha-mapping mapping)}
      (rotate (alpha (first init-pos)))))

(-&gt;&gt; (rotor "BDAC" "A")
     :mapping)
;; =&gt; {0 1, 1 3, 2 0, 3 2}

(-&gt;&gt; (rotor "BDAC" "B")
     :mapping)
;; =&gt; {3 0, 0 2, 1 3, 2 1}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, since we changed our rotor construction signature we broke all our tests. But it won&#8217;t be the last time we do that, so no problem, we&#8217;ll just add in A for the init-pos param.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stepping">Stepping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we have the multiple starting positions for our rotors, but they remain static through the encoding. This is a problem, because it produces very weak codes. To see why, look at what happens when you encode AAAA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(encode "AAAA" [(rotor "BCAD" "A")])
;; =&gt; "DDDD"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is obviously super easy to crack, since even if you don&#8217;t use statistical methods to look at how frequently letters appear, there is a pretty limited set of possibilities.</p>
</div>
<div class="paragraph">
<p>What you need to do is make A map to a different letter each time you use it. This is what we get by rotating the rotors when you hit a letter on the keyboard.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s change our <code>rotate</code> function a bit. Rotating by 1 is going to be very common, so we can make a nice 1 arity function for it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn rotate
  ([rotor] (rotate rotor 1))
  ([rotor steps]
   (letfn [(f [v] (mod (- v steps) (count (:mapping rotor))))]
     (-&gt; rotor
         (assoc :mapping (into {} (map (fn [[k v]] [(f k) (f v)]) (:mapping rotor))))))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, let&#8217;s try to get one rotor rotating one notch after each character. Happily, we can do this with a single line of code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn encode
  ([plaintext rotors] (encode [] (str-&gt;num plaintext) rotors))
  ([encoded plaintext rotors]
   (if (empty? plaintext) (num-&gt;str encoded)
       (recur (conj encoded (encode-letter (first plaintext) (map :mapping rotors)))
              (rest plaintext)
              (map rotate rotors)))))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
this rotates <em>all</em> the rotors, so trying this with multiple rotors might yield weird results.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now if we try encoding AAAA again, we get this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(encode "AAAA" [(rotor "BCAD" "A")])
;; =&gt; "DBDB"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This non-similarity is not guaranteed.
<code>(encode "AAAA" [(rotor "BADC" "A")]) ;; &#8658; "CCCC"</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This again breaks a few of our "these-will-break" tests, which we&#8217;ll fix, but none of the others, which is good.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll put in a non-similarity test too, checking that whatever output we get from AAAA, BBBB, CCCC, DDDD, they are not all the same letter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(deftest non-similarity
  (let [rotors [(rotor "BADC" "A") (rotor "ACDB" "A") (rotor "BDAC" "A")]]
    (are [input] (not (apply = (encode input rotors)))
      "AAAA"
      "BBBB"
      "CCCC"
      "DDDD")))</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_worked_example">Worked example</h3>
<div class="paragraph">
<p>I want to make sure that I can replicate my results with pen and paper while it&#8217;s still simple enough to do so! So let&#8217;s work through the example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(encode "ABCDBA" [(rotor "BDCA" "A")])
;; =&gt; "BCDAAD"</code></pre>
</div>
</div>
<div class="paragraph">
<p>(recall the simple-reflector we have in place is A&lt; - &gt;C, B&lt; - &gt;D)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/enigma/enigma(6).jpg" alt="enigma(6)">
</div>
</div>
<div class="paragraph">
<p>I&#8217;ll add this as a test as-well, since this shouldn&#8217;t change anymore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(deftest these-shouldnt-break
  (is (= "BCDAAD" (encode "ABCDBA" [(rotor "BDCA" "A" "A")]))))</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_notches">Notches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OK, so we have one rotor moving, next we need to make that rotor move all the others when the notch is passed.</p>
</div>
<div class="paragraph">
<p>First we need to model the notch in our constructor: <code>(rotor mapping notch init-pos)</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn rotor [mapping notches init-pos]
  (-&gt; {:mapping (alpha-mapping mapping)
       :notches (mapv alpha notches)}
      (rotate (alpha (first init-pos)))))

(rotor "BCAD" "C" "A")
;; =&gt; {:mapping {0 1, 1 2, 2 0, 3 3}, :notches [2]}
(rotor "BCAD" "CA" "A")
;; =&gt; {:mapping {0 1, 1 2, 2 0, 3 3}, :notches [2 0]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I don&#8217;t think I&#8217;m going to do much on rotors with multiple notches, but it should be easy enough to implement.</p>
</div>
<div class="paragraph">
<p>Next, we need to thing about what the impact of rotation on notches is.</p>
</div>
<div class="paragraph">
<p><strong>diagram</strong></p>
</div>
<div class="paragraph">
<p>Pretty simple, it moves up one each time, and its number decreases. This is nice, because it means that the rotor to the left of this rotor will rotate if this rotors notch setting is 0.</p>
</div>
<div class="paragraph">
<p>So we can update our rotate function thus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn rotate
  ([rotor] (rotate rotor 1))
  ([rotor steps]
   (letfn [(f [v] (mod (- v steps) (count (:mapping rotor))))]
     (-&gt; rotor
         (assoc :mapping (into {} (map (fn [[k v]] [(f k) (f v)]) (:mapping rotor))))
         (update :notches #(mapv f %))))))

(defn rotor [mapping notches init-pos]
  (-&gt; {:mapping (alpha-mapping mapping)
       :notches (mapv alpha notches)}
      (rotate (alpha (first init-pos)))))

(rotor "BCAD" "C" "A")
;; =&gt; {:mapping {0 1, 1 2, 2 0, 3 3}, :notches [2]}
(rotor "BCAD" "CA" "A")
;; =&gt; {:mapping {0 1, 1 2, 2 0, 3 3}, :notches [2 0]}

(map #(rotor "BCAD" "C" %) ["A" "B" "C" "D"])
;; =&gt; ({:mapping {0 1, 1 2, 2 0, 3 3}, :notches [2]}
;;     {:mapping {3 0, 0 1, 1 3, 2 2}, :notches [1]}
;;     {:mapping {2 3, 3 0, 0 2, 1 1}, :notches [0]}
;;     {:mapping {1 2, 2 3, 3 1, 0 0}, :notches [3]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Completely by accident, I can reuse the 'f' function I defined inline, which was nice.</p>
</div>
<div class="paragraph">
<p>Next I need a function that takes a seq of rotors, and returns a new set of rotors which makes sure the notches are factored.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn notch-passed? [rotor] (some zero? (:notches rotor)))

(defn step [notch? rotors]
  (if (empty? rotors) nil
      (cons
       (if notch? (rotate (first rotors)) (first rotors))
       (step (notch-passed? (first rotors)) (rest rotors)))))

(step true [(rotor "BCAD" "A" "A") (rotor "ACDB" "A" "A")])
;; =&gt; ({:mapping {3 0, 0 1, 1 3, 2 2}, :notches [3]}
;;     {:mapping {3 3, 0 1, 1 2, 2 0}, :notches [3]})

(step true [(rotor "BCAD" "B" "A") (rotor "ACDB" "A" "A")])
;; =&gt; ({:mapping {3 0, 0 1, 1 3, 2 2}, :notches [0]}
;;     {:mapping {0 0, 1 2, 2 3, 3 1}, :notches [0]})</code></pre>
</div>
</div>
<div class="paragraph">
<p>A little ugly with that nested if. Slightly nicer is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn step [notch? rotors]
  (if (empty? rotors) nil
      (cons
       (cond-&gt; (first rotors) notch? rotate)
       (step (notch-passed? (first rotors)) (rest rotors)))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Encode simply has the last line updated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(defn encode
  ([plaintext rotors] (encode [] (str-&gt;num plaintext) rotors))
  ([encoded plaintext rotors]
   (if (empty? plaintext) (num-&gt;str encoded)
       (recur (conj encoded (encode-letter (first plaintext) (map :mapping rotors)))
              (rest plaintext)
              (step true rotors)))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ve changed the rotor constructor again, so obviously all the tests broke. But once I fixed the constructors, the only things which broke were things in the 'these will break' test.</p>
</div>
<div class="sect2">
<h3 id="_another_worked_example">Another worked example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-clojure" data-lang="clojure">(encode "ABCDCADB" [(rotor "ACDB" "C" "A") (rotor "BDCA" "B" "A")])
;; =&gt; "DDBCABBD"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_pause">A pause</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After all of this we have nearly 50 lines of code if you include blank lines! A massive program to be sure. Plus about 30 lines of tests.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look back at our initial list of concepts to see what&#8217;s left</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The reflector <strong>DONE</strong></p>
</li>
<li>
<p>The rotors <strong>DONE</strong></p>
</li>
<li>
<p>The window setting of the rotors <strong>DONE</strong></p>
</li>
<li>
<p>The Notch positions <strong>DONE</strong></p>
</li>
<li>
<p>Ring settings</p>
</li>
<li>
<p>The Plugboard</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So only the ring settings and the plugboard to go.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ring_settings">Ring settings</h2>
<div class="sectionbody">

</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-04-30 14:07:35 +0100
</div>
</div>
</body>
</html>